<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Students â€¢ Attendance Portal (Premium)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #071021;
  --card: #0d182f;
  --text: #e6eef8;
  --muted: #9ca3af;
  --accent: #06b6d4;
}
body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0; padding: 0;
}
header {
  background: var(--card);
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
header h1 { font-size: 20px; margin: 0; }
#searchBar {
  background: #0f1b35;
  border: 1px solid rgba(255,255,255,0.1);
  padding: 8px 10px;
  color: var(--text);
  border-radius: 8px;
  width: 220px;
}
#studentsList {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
}
.studentItem {
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--card);
  border-radius: 12px;
  padding: 12px 16px;
  border: 1px solid rgba(255,255,255,0.03);
}
.studentItem:hover { background: #112244; transition: 0.2s; }
.avatar {
  width: 60px; height: 60px;
  border-radius: 10px;
  background: linear-gradient(135deg,#06b6d4,#0ea5e9);
  display: flex; justify-content: center; align-items: center;
  font-weight: 700; font-size: 20px;
  color: #fff;
}
.smeta h3 { margin: 0; font-size: 17px; }
.smeta p { margin: 2px 0 8px 0; color: var(--muted); }
.loginRow { display: flex; gap: 8px; }
.loginRow input.pin {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.1);
  background: #0f1b35;
  color: var(--text);
}
.loginRow .btn {
  background: var(--accent);
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  color: #fff;
  cursor: pointer;
}
#overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  justify-content: center;
  align-items: center;
  z-index: 100;
}
.overlayBox {
  background: var(--card);
  padding: 20px;
  border-radius: 14px;
  width: 340px;
}
.overlayBox input, .overlayBox textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid rgba(255,255,255,0.1);
  background: #0f1b35;
  color: var(--text);
  border-radius: 8px;
  margin-top: 6px;
}
.overlayBox button {
  margin-top: 10px;
  width: 100%;
  background: var(--accent);
  border: none;
  padding: 10px;
  color: #fff;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}
.feedItem {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
}
.feedItem img {
  width: 36px; height: 36px; border-radius: 8px;
  object-fit: cover;
}
.metaSmall {
  color: var(--muted);
  font-size: 13px;
}
.topCard {
  background: var(--card);
  border-radius: 10px;
  padding: 10px;
  text-align: center;
}
.smallMuted { color: var(--muted); font-size: 13px; }
</style>
</head>
<body>

<header>
  <h1>Students Attendance Portal</h1>
  <input id="searchBar" type="text" placeholder="ðŸ” Search student..." />
</header>

<div id="studentsList"></div>

<!-- overlay student dashboard -->
<div id="overlay">
  <div class="overlayBox">
    <img id="dashAvatar" src="" alt="avatar" style="width:80px;height:80px;border-radius:10px;object-fit:cover;margin-bottom:10px;">
    <h3 id="dashName"></h3>
    <p id="dashMeta" class="smallMuted"></p>
    <input id="inpName" placeholder="Full name">
    <input id="inpMobile" placeholder="Mobile">
    <input id="inpClass" placeholder="Class">
    <input id="inpJob" placeholder="Goal / Job Target">
    <input id="inpStatus" placeholder="Status">
    <input id="inpPic" type="file">
    <button id="saveProfile">Save Profile</button>
    <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.1)">
    <button id="markBtn">Mark Attendance</button>
    <div id="markMsg" style="margin-top:8px"></div>
    <h4 style="margin-top:16px">Your Attendance</h4>
    <div id="yourRecent" style="max-height:180px;overflow:auto"></div>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<!-- Attendance Feed & Top 3 -->
<div style="padding:20px">
  <h2>Live Attendance Feed</h2>
  <div id="attendanceFeed" style="max-height:220px;overflow:auto"></div>

  <h2 style="margin-top:20px">Top 3 Students</h2>
  <div id="top3area" style="display:flex;gap:10px;"></div>

  <h3 style="margin-top:20px">Teacher Report</h3>
  <input id="teacherSecret" placeholder="Enter Teacher Code" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:#0f1b35;color:#fff;">
  <button id="teacherBtn" style="background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Open Report</button>
</div>
<!-- PART 2: Firebase Setup & Bootstrap -->
<script type="module">
  // Firebase modular imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

  // ---------- Firebase Config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCb5MYw_DFba34lPHbME0stKdFG7yO3J6E",
    authDomain: "students-attendance-file.firebaseapp.com",
    projectId: "students-attendance-file",
    storageBucket: "students-attendance-file.firebasestorage.app",
    messagingSenderId: "345717849296",
    appId: "1:345717849296:web:e41ec4f10b100d8613f2d5",
    measurementId: "G-FSYN886316"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ---------- Initial students (bootstrap if collection empty) ----------
  const initialStudents = [
    { name: "Ravi Kumar", code: "1111", class: "10-A" },
    { name: "Sita Sharma", code: "2222", class: "10-A" },
    { name: "Amit Singh", code: "3333", class: "10-A" },
    { name: "Pooja Verma", code: "4444", class: "10-A" },
    { name: "Rahul Meena", code: "5555", class: "10-A" }
  ];

  async function bootstrapIfEmpty() {
    const snap = await getDocs(collection(db, 'students'));
    if(snap.empty) {
      for(const s of initialStudents) {
        await addDoc(collection(db,'students'), s);
      }
      console.log("Initial students added!");
    }
  }

  await bootstrapIfEmpty();
</script>
<!-- PART 3: UI References & Student Login -->
<script type="module">
  // ---------- UI references ----------
  const studentsListEl = document.getElementById('studentsList');
  const publicProfilesEl = document.getElementById('publicProfiles');
  const attendanceFeedEl = document.getElementById('attendanceFeed');
  const top3area = document.getElementById('top3area');
  const overlay = document.getElementById('overlay');
  const dashAvatar = document.getElementById('dashAvatar');
  const dashName = document.getElementById('dashName');
  const dashMeta = document.getElementById('dashMeta');
  const inpName = document.getElementById('inpName');
  const inpMobile = document.getElementById('inpMobile');
  const inpClass = document.getElementById('inpClass');
  const inpJob = document.getElementById('inpJob');
  const inpStatus = document.getElementById('inpStatus');
  const inpPic = document.getElementById('inpPic');
  const saveProfileBtn = document.getElementById('saveProfile');
  const saveMarkBtn = document.getElementById('markBtn');
  const yourRecentEl = document.getElementById('yourRecent');
  const markMsg = document.getElementById('markMsg');

  let studentsCache = []; // array of {id, data}
  let currentStudent = null; // {id, data}

  // ---------- render students list (public) ----------
  function renderStudentsList() {
    studentsListEl.innerHTML = '';
    publicProfilesEl.innerHTML = '';
    for(const s of studentsCache) {
      const data = s.data;

      // LEFT SIDE: Students Board
      const card = document.createElement('div');
      card.className = 'studentItem';
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      if(data.profilePicURL){
        const img = document.createElement('img');
        img.src = data.profilePicURL;
        img.style.width='60px'; img.style.height='60px'; img.style.borderRadius='10px'; img.style.objectFit='cover';
        avatar.innerHTML=''; avatar.appendChild(img);
      } else { avatar.textContent = (data.name||'S')[0]; }

      const meta = document.createElement('div');
      meta.className = 'smeta';
      meta.innerHTML = `<h3>${escapeHtml(data.name||'â€”')}</h3>
                        <p>${escapeHtml(data.class||'')} â€¢ <span style="color:var(--muted)">${escapeHtml(data.jobTarget||'')}</span></p>
                        <div class="loginRow">
                          <input class="pin" placeholder="Enter PIN" data-id="${s.id}">
                          <button class="btn" data-id="${s.id}">Login</button>
                        </div>`;
      card.appendChild(avatar); card.appendChild(meta);
      studentsListEl.appendChild(card);

      // RIGHT SIDE: Public Profiles Grid
      const profCard = document.createElement('div');
      profCard.style.cssText = 'background:var(--card);padding:10px;border-radius:10px;width:140px;text-align:center;border:1px solid rgba(255,255,255,0.02)';
      const imgEl = document.createElement('img');
      imgEl.style.cssText = 'width:84px;height:84px;border-radius:8px;object-fit:cover;margin-bottom:8px';
      imgEl.src = data.profilePicURL || '';
      imgEl.alt = data.name || '';
      if(!data.profilePicURL) imgEl.style.background = 'linear-gradient(135deg,#06b6d4,#0ea5e9)';
      const nm = document.createElement('div'); nm.textContent = data.name||''; nm.style.fontWeight=700;
      const st = document.createElement('div'); st.className='smallMuted'; st.style.marginTop='6px'; st.textContent = data.status||'';
      profCard.appendChild(imgEl); profCard.appendChild(nm); profCard.appendChild(st);
      publicProfilesEl.appendChild(profCard);
    }
  }

  // ---------- escape HTML helper ----------
  function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ---------- student login handler ----------
  studentsListEl.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button.btn');
    if(!btn) return;
    const id = btn.dataset.id;
    const pinInput = document.querySelector(`input.pin[data-id="${id}"]`);
    const pin = pinInput ? pinInput.value.trim() : '';
    if(!pin){ alert('Enter PIN for login'); return; }

    const sdoc = studentsCache.find(x=>x.id===id);
    if(!sdoc){ alert('Student not found'); return; }
    if(String(sdoc.data.code||'') !== String(pin)){ alert('Invalid PIN'); return; }

    // success -> open dashboard
    currentStudent = { id: sdoc.id, data: sdoc.data };
    openDashboard();
  });

  // ---------- overlay open/close ----------
  document.getElementById('logoutBtn').addEventListener('click', ()=>{ closeDashboard(); });
  function openDashboard(){
    if(!currentStudent) return;
    dashName.textContent = currentStudent.data.name||'Student';
    dashMeta.textContent = `${currentStudent.data.class||''} â€¢ ${currentStudent.data.mobile||''}`;
    dashAvatar.src = currentStudent.data.profilePicURL||'';
    dashAvatar.style.display = currentStudent.data.profilePicURL?'block':'none';
    inpName.value = currentStudent.data.name||'';
    inpMobile.value = currentStudent.data.mobile||'';
    inpClass.value = currentStudent.data.class||'';
    inpJob.value = currentStudent.data.jobTarget||'';
    inpStatus.value = currentStudent.data.status||'';
    markMsg.textContent = '';
    overlay.style.display = 'flex';
    loadYourRecent();
  }
  function closeDashboard(){ overlay.style.display='none'; currentStudent=null; }

</script>
<!-- PART 4: Profile Save, Attendance Mark, Recent Attendance, Live Feed -->
<script type="module">

  // ---------- save profile (with optional pic) ----------
  saveProfileBtn.addEventListener('click', async ()=>{
    if(!currentStudent) return;
    const updates = {
      name: inpName.value.trim(),
      mobile: inpMobile.value.trim(),
      class: inpClass.value.trim(),
      jobTarget: inpJob.value.trim(),
      status: inpStatus.value.trim()
    };

    const file = inpPic.files[0];
    if(file){
      const storRef = ref(storage, 'profilePics/' + currentStudent.id + '/' + Date.now());
      await uploadBytes(storRef, file);
      updates.profilePicURL = await getDownloadURL(storRef);
    }

    await updateDoc(doc(db,'students',currentStudent.id), updates);

    // reflect local cache
    currentStudent.data = {...currentStudent.data, ...updates};
    const idx = studentsCache.findIndex(x=>x.id===currentStudent.id);
    if(idx>=0) studentsCache[idx].data = currentStudent.data;

    renderStudentsList();
    dashName.textContent = currentStudent.data.name||'';
    dashMeta.textContent = `${currentStudent.data.class||''} â€¢ ${currentStudent.data.mobile||''}`;
    if(currentStudent.data.profilePicURL){ dashAvatar.src = currentStudent.data.profilePicURL; dashAvatar.style.display='block'; }

    alert('Profile saved âœ…');
  });

  // ---------- mark attendance (today only) ----------
  saveMarkBtn.addEventListener('click', async ()=>{
    if(!currentStudent) return;
    const today = new Date().toISOString().slice(0,10);
    const q = query(collection(db,'attendance'), where('studentId','==',currentStudent.id), where('date','==',today));
    const snap = await getDocs(q);
    if(!snap.empty){ markMsg.textContent='You already marked attendance for today.'; return; }

    await addDoc(collection(db,'attendance'), {
      studentId: currentStudent.id,
      name: currentStudent.data.name||'',
      date: today,
      status: 'Present',
      time: serverTimestamp()
    });

    markMsg.textContent = 'Attendance marked âœ…';
    loadYourRecent();
  });

  // ---------- load your recent attendance ----------
  async function loadYourRecent(){
    if(!currentStudent) return;
    yourRecentEl.innerHTML='';
    const attQ = query(collection(db,'attendance'), where('studentId','==',currentStudent.id), orderBy('time','desc'));
    const snap = await getDocs(attQ);
    if(snap.empty){ yourRecentEl.innerHTML='<div class="smallMuted">No attendance yet</div>'; return; }

    snap.forEach(d=>{
      const data = d.data();
      const timeText = data.time && data.time.toDate ? data.time.toDate().toLocaleString() : data.time || data.date;
      const el = document.createElement('div'); el.className='feedItem';
      el.innerHTML = `<div style="width:10px;height:10px;border-radius:50%;background:var(--accent)"></div>
                      <div style="flex:1"><div style="font-weight:700">${data.name}</div><div class="metaSmall">${data.date} â€¢ ${timeText}</div></div>`;
      yourRecentEl.appendChild(el);
    });
  }

  // ---------- live attendance feed (public) ----------
  function startAttendanceFeed(){
    const q = query(collection(db,'attendance'), orderBy('time','desc'));
    onSnapshot(q, snap=>{
      attendanceFeedEl.innerHTML='';
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const timeText = d.time && d.time.toDate ? d.time.toDate().toLocaleString() : d.date;
        const item = document.createElement('div'); item.className='feedItem';
        const stud = studentsCache.find(s=>s.id===d.studentId);
        const img = document.createElement('img'); img.src = stud?.data?.profilePicURL||'';
        if(!img.src) img.style.background='linear-gradient(135deg,#06b6d4,#0ea5e9)';
        item.appendChild(img);
        const md = document.createElement('div');
        md.innerHTML=`<div style="font-weight:700">${escapeHtml(d.name||'â€”')}</div><div class="metaSmall">${escapeHtml(d.date)} â€¢ ${escapeHtml(timeText)}</div>`;
        item.appendChild(md);
        attendanceFeedEl.appendChild(item);
      });
    });
  }

  // ---------- load students into cache ----------
  function startStudentsListener(){
    const q = query(collection(db,'students'));
    onSnapshot(q, snap=>{
      studentsCache=[];
      snap.forEach(d=>studentsCache.push({id:d.id,data:d.data()}));
      renderStudentsList();
      computeTop3();
    });
  }

  // ---------- compute top 3 students ----------
  async function computeTop3(){
    const attSnap = await getDocs(collection(db,'attendance'));
    const counts={};
    attSnap.forEach(a=>{ const ad=a.data(); counts[ad.studentId]=(counts[ad.studentId]||0)+1; });
    const arr = studentsCache.map(s=>({id:s.id,name:s.data.name,total:counts[s.id]||0}));
    arr.sort((a,b)=>b.total - a.total);
    const top = arr.slice(0,3);
    top3area.innerHTML='';
    for(const t of top){
      const c = document.createElement('div'); c.className='topCard';
      c.innerHTML=`<h4 class="smallMuted">${escapeHtml(t.name||'â€”')}</h4><p>${t.total}</p>`;
      top3area.appendChild(c);
    }
  }

</script>
<!-- PART 5: Teacher view, refresh, startup, initialization -->
<script type="module">

  // ---------- teacher view ----------
  document.getElementById('teacherBtn').addEventListener('click', async ()=>{
    const code = document.getElementById('teacherSecret').value.trim();
    if(code !== 'TEACHER123'){ alert('Invalid teacher code'); return; }

    // fetch students & attendance
    const studSnap = await getDocs(collection(db,'students'));
    const attSnap = await getDocs(collection(db,'attendance'));

    // attendance grouped
    const map = {};
    attSnap.forEach(a=>{
      const d = a.data();
      map[d.studentId] = map[d.studentId] ? map[d.studentId]+1 : 1;
    });

    let html = '<div style="max-height:420px;overflow:auto">';
    html += '<table style="width:100%;border-collapse:collapse;color:#e6eef8">';
    html += '<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)">Name</th>';
    html += '<th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)">Mobile</th>';
    html += '<th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)">Class</th>';
    html += '<th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)">Total</th></tr></thead><tbody>';

    studSnap.forEach(s=>{
      const d = s.data();
      html += `<tr><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${escapeHtml(d.name||'')}</td>`;
      html += `<td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${escapeHtml(d.mobile||'')}</td>`;
      html += `<td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${escapeHtml(d.class||'')}</td>`;
      html += `<td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${map[s.id]||0}</td></tr>`;
    });

    html += '</tbody></table></div>';

    // open report in new window
    alert('Teacher access granted â€” report will open in a new window.');
    const w = window.open('', '_blank');
    w.document.write(`<html><head><title>Teacher Report</title><meta charset="utf-8">`);
    w.document.write(`<style>body{background:#071021;color:#e6eef8;font-family:Inter,Arial;padding:18px}</style></head><body>`);
    w.document.write(`<h2>All Students Report</h2>${html}</body></html>`);
  });

  // ---------- small helpers ----------
  document.getElementById('refreshBtn').addEventListener('click', ()=>{
    renderStudentsList();
    computeTop3();
  });

  // ---------- startup ----------
  (async function init(){
    try{
      await bootstrapIfEmpty();
    }catch(e){ console.error('bootstrap error', e); }
    startStudentsListener();
    startAttendanceFeed();
    computeTop3();
  })();

</script>